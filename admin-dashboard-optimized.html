<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>系统管理 - AI Knowledge Agent</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Inter', 'Segoe UI', sans-serif;
            background: linear-gradient(135deg, #0f0f23 0%, #1a1a2e 50%, #16213e 100%);
            min-height: 100vh;
            color: #e2e8f0;
            padding: 20px;
        }
        
        .dashboard {
            max-width: 1200px;
            margin: 0 auto;
        }
        
        .header {
            text-align: center;
            margin-bottom: 30px;
        }
        
        .header h1 {
            font-size: 2.5rem;
            margin-bottom: 10px;
            background: linear-gradient(135deg, #10b981, #3b82f6);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }
        
        .status-banner {
            background: rgba(16, 185, 129, 0.1);
            border: 1px solid rgba(16, 185, 129, 0.3);
            border-radius: 16px;
            padding: 20px;
            margin-bottom: 30px;
            text-align: center;
        }
        
        .status-banner.warning {
            background: rgba(245, 158, 11, 0.1);
            border-color: rgba(245, 158, 11, 0.3);
        }
        
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }
        
        .stat-card {
            background: rgba(255, 255, 255, 0.05);
            backdrop-filter: blur(20px);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 16px;
            padding: 24px;
            text-align: center;
        }
        
        .stat-card h3 {
            font-size: 0.9rem;
            color: rgba(226, 232, 240, 0.7);
            margin-bottom: 8px;
        }
        
        .stat-card .value {
            font-size: 2rem;
            font-weight: 700;
            margin-bottom: 8px;
        }
        
        .stat-card .change {
            font-size: 0.8rem;
            padding: 4px 8px;
            border-radius: 12px;
        }
        
        .positive { background: rgba(16, 185, 129, 0.2); color: #10b981; }
        .negative { background: rgba(239, 68, 68, 0.2); color: #ef4444; }
        .neutral { background: rgba(156, 163, 175, 0.2); color: #9ca3af; }
        
        .control-panel {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }
        
        .panel-section {
            background: rgba(255, 255, 255, 0.05);
            backdrop-filter: blur(20px);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 16px;
            padding: 24px;
        }
        
        .panel-section h3 {
            margin-bottom: 16px;
            color: #e2e8f0;
        }
        
        .btn {
            padding: 10px 16px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 500;
            margin: 4px;
            transition: all 0.3s ease;
        }
        
        .btn-primary { background: #3b82f6; color: white; }
        .btn-success { background: #10b981; color: white; }
        .btn-warning { background: #f59e0b; color: white; }
        .btn-danger { background: #ef4444; color: white; }
        
        .btn:hover { transform: translateY(-1px); opacity: 0.9; }
        
        .progress-bar {
            background: rgba(255, 255, 255, 0.1);
            border-radius: 10px;
            height: 8px;
            overflow: hidden;
            margin: 8px 0;
        }
        
        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, #10b981, #3b82f6);
            transition: width 0.3s ease;
        }
        
        .status-indicator {
            display: inline-block;
            width: 8px;
            height: 8px;
            border-radius: 50%;
            margin-right: 8px;
        }
        
        .status-online { background: #10b981; }
        .status-offline { background: #ef4444; }
        .status-warning { background: #f59e0b; }
        
        .log-viewer {
            background: rgba(0, 0, 0, 0.3);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 8px;
            padding: 16px;
            height: 200px;
            overflow-y: auto;
            font-family: 'Courier New', monospace;
            font-size: 0.8rem;
            line-height: 1.4;
        }
        
        .back-link {
            text-align: center;
            margin-top: 30px;
        }
        
        .back-link a {
            color: #60a5fa;
            text-decoration: none;
            padding: 10px 20px;
            border: 1px solid rgba(96, 165, 250, 0.3);
            border-radius: 20px;
            transition: all 0.3s ease;
        }
        
        .back-link a:hover {
            background: rgba(96, 165, 250, 0.1);
            border-color: rgba(96, 165, 250, 0.5);
        }
    </style>
</head>
<body>
    <div class="dashboard">
        <div class="header">
            <h1>🛠️ 系统管理面板</h1>
            <p>AI Knowledge Agent 运行状态监控与管理</p>
        </div>
        
        <!-- 系统状态横幅 -->
        <div class="status-banner" id="statusBanner">
            <h3>✅ 系统运行正常</h3>
            <p>所有核心功能正常工作，知识库和AI服务可用</p>
        </div>
        
        <!-- 统计卡片 -->
        <div class="stats-grid">
            <div class="stat-card">
                <h3>知识库条目</h3>
                <div class="value" id="knowledgeCount">-</div>
                <div class="change neutral" id="knowledgeChange">加载中...</div>
            </div>
            
            <div class="stat-card">
                <h3>存储使用率</h3>
                <div class="value" id="storageUsage">-</div>
                <div class="change" id="storageChange">-</div>
            </div>
            
            <div class="stat-card">
                <h3>AI服务状态</h3>
                <div class="value" id="aiStatus">-</div>
                <div class="change" id="aiChange">检测中...</div>
            </div>
            
            <div class="stat-card">
                <h3>系统健康度</h3>
                <div class="value" id="systemHealth">-</div>
                <div class="change" id="healthChange">-</div>
            </div>
        </div>
        
        <!-- 控制面板 -->
        <div class="control-panel">
            <!-- 数据管理 -->
            <div class="panel-section">
                <h3>📊 数据管理</h3>
                <button class="btn btn-primary" onclick="refreshData()">刷新数据</button>
                <button class="btn btn-success" onclick="exportData()">导出数据</button>
                <button class="btn btn-warning" onclick="optimizeData()">优化数据</button>
                <button class="btn btn-danger" onclick="clearData()">清空数据</button>
                
                <div style="margin-top: 16px;">
                    <div>存储空间使用情况:</div>
                    <div class="progress-bar">
                        <div class="progress-fill" id="storageProgress" style="width: 0%"></div>
                    </div>
                    <div style="font-size: 0.8rem; color: rgba(226, 232, 240, 0.7);" id="storageDetails">-</div>
                </div>
            </div>
            
            <!-- AI服务管理 -->
            <div class="panel-section">
                <h3>🤖 AI服务管理</h3>
                <div style="margin-bottom: 12px;">
                    <span class="status-indicator" id="githubStatus"></span>
                    GitHub Models
                </div>
                <div style="margin-bottom: 12px;">
                    <span class="status-indicator" id="bedrockStatus"></span>
                    AWS Bedrock
                </div>
                
                <button class="btn btn-primary" onclick="testAIServices()">测试服务</button>
                <button class="btn btn-success" onclick="window.open('ai-config.html', '_blank')">配置AI</button>
            </div>
            
            <!-- 知识库管理 -->
            <div class="panel-section">
                <h3>📚 知识库管理</h3>
                <button class="btn btn-primary" onclick="viewKnowledgeBase()">查看内容</button>
                <button class="btn btn-success" onclick="addContent()">添加内容</button>
                <button class="btn btn-warning" onclick="updateContent()">更新内容</button>
                
                <div style="margin-top: 16px;">
                    <div>内容质量分布:</div>
                    <div class="progress-bar">
                        <div class="progress-fill" id="qualityProgress" style="width: 75%"></div>
                    </div>
                    <div style="font-size: 0.8rem; color: rgba(226, 232, 240, 0.7);">高质量内容占比: 75%</div>
                </div>
            </div>
            
            <!-- 系统监控 -->
            <div class="panel-section">
                <h3>📈 系统监控</h3>
                <button class="btn btn-primary" onclick="generateReport()">生成报告</button>
                <button class="btn btn-success" onclick="downloadLogs()">下载日志</button>
                <button class="btn btn-warning" onclick="clearLogs()">清空日志</button>
                
                <div style="margin-top: 16px;">
                    <div>系统日志:</div>
                    <div class="log-viewer" id="systemLogs">系统启动中...</div>
                </div>
            </div>
        </div>
        
        <div class="back-link">
            <a href="index.html">← 返回主页</a>
        </div>
    </div>
    
    <script src="github-models-integration.js"></script>
    <script>
        let systemLogs = [];
        
        // 页面加载时初始化
        window.onload = function() {
            initializeDashboard();
            updateStats();
            setInterval(updateStats, 30000); // 每30秒更新一次
        };
        
        function initializeDashboard() {
            log('✅ 系统管理面板初始化完成');
            checkAIServices();
            updateSystemHealth();
        }
        
        function updateStats() {
            updateKnowledgeStats();
            updateStorageStats();
            updateSystemHealth();
        }
        
        function updateKnowledgeStats() {
            const knowledgeBase = JSON.parse(localStorage.getItem('crawled_knowledge_base') || '[]');
            const count = knowledgeBase.length;
            
            document.getElementById('knowledgeCount').textContent = count;
            document.getElementById('knowledgeChange').textContent = `${count} 条记录`;
            document.getElementById('knowledgeChange').className = count > 0 ? 'change positive' : 'change neutral';
        }
        
        function updateStorageStats() {
            let totalSize = 0;
            for (let key in localStorage) {
                if (localStorage.hasOwnProperty(key)) {
                    totalSize += localStorage[key].length;
                }
            }
            
            const usageMB = (totalSize / 1024 / 1024).toFixed(2);
            const usagePercent = Math.min((totalSize / (5 * 1024 * 1024)) * 100, 100);
            
            document.getElementById('storageUsage').textContent = `${usageMB}MB`;
            document.getElementById('storageChange').textContent = `${usagePercent.toFixed(1)}% 已使用`;
            document.getElementById('storageChange').className = usagePercent > 80 ? 'change negative' : 
                                                                usagePercent > 60 ? 'change warning' : 'change positive';
            
            document.getElementById('storageProgress').style.width = `${usagePercent}%`;
            document.getElementById('storageDetails').textContent = `${usageMB}MB / 5.00MB (${usagePercent.toFixed(1)}%)`;
        }
        
        function updateSystemHealth() {
            const knowledgeBase = JSON.parse(localStorage.getItem('crawled_knowledge_base') || '[]');
            const githubToken = localStorage.getItem('github_models_token');
            
            let healthScore = 60; // 基础分数
            
            // 知识库内容加分
            if (knowledgeBase.length > 0) healthScore += 20;
            if (knowledgeBase.length > 10) healthScore += 10;
            
            // AI配置加分
            if (githubToken) healthScore += 10;
            
            document.getElementById('systemHealth').textContent = `${healthScore}%`;
            document.getElementById('healthChange').textContent = healthScore >= 80 ? '优秀' : healthScore >= 60 ? '良好' : '需要改进';
            document.getElementById('healthChange').className = healthScore >= 80 ? 'change positive' : 
                                                              healthScore >= 60 ? 'change neutral' : 'change negative';
        }
        
        async function checkAIServices() {
            // 检查GitHub Models
            const githubToken = localStorage.getItem('github_models_token');
            const githubStatus = document.getElementById('githubStatus');
            
            if (githubToken) {
                try {
                    const githubAI = new GitHubModelsAI();
                    const isWorking = await githubAI.testConnection();
                    githubStatus.className = isWorking ? 'status-indicator status-online' : 'status-indicator status-offline';
                    document.getElementById('aiStatus').textContent = isWorking ? '在线' : '离线';
                    document.getElementById('aiChange').textContent = isWorking ? 'GitHub Models 可用' : 'GitHub Models 不可用';
                    document.getElementById('aiChange').className = isWorking ? 'change positive' : 'change negative';
                } catch (error) {
                    githubStatus.className = 'status-indicator status-offline';
                    log(`GitHub Models 连接失败: ${error.message}`);
                }
            } else {
                githubStatus.className = 'status-indicator status-warning';
                document.getElementById('aiStatus').textContent = '未配置';
                document.getElementById('aiChange').textContent = '需要配置AI服务';
                document.getElementById('aiChange').className = 'change neutral';
            }
            
            // 检查Bedrock
            const bedrockStatus = document.getElementById('bedrockStatus');
            const bedrockKey = localStorage.getItem('bedrock_api_key');
            bedrockStatus.className = bedrockKey ? 'status-indicator status-warning' : 'status-indicator status-offline';
        }
        
        function refreshData() {
            log('🔄 刷新数据...');
            updateStats();
            checkAIServices();
            log('✅ 数据刷新完成');
        }
        
        function exportData() {
            const data = {
                knowledgeBase: JSON.parse(localStorage.getItem('crawled_knowledge_base') || '[]'),
                settings: {
                    github_token: localStorage.getItem('github_models_token') ? '***' : null,
                    github_model: localStorage.getItem('github_models_current'),
                },
                exportTime: new Date().toISOString()
            };
            
            const blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `ai-knowledge-backup-${new Date().toISOString().split('T')[0]}.json`;
            a.click();
            URL.revokeObjectURL(url);
            
            log('📥 数据导出完成');
        }
        
        function optimizeData() {
            log('🔧 开始数据优化...');
            
            const kb = JSON.parse(localStorage.getItem('crawled_knowledge_base') || '[]');
            const optimized = kb.slice(0, 500); // 只保留500条最新的
            localStorage.setItem('crawled_knowledge_base', JSON.stringify(optimized));
            log(`✅ 数据优化完成: ${kb.length} -> ${optimized.length} 条记录`);
            
            updateStats();
        }
        
        function clearData() {
            if (confirm('确定要清空所有数据吗？此操作不可恢复！')) {
                localStorage.removeItem('crawled_knowledge_base');
                localStorage.removeItem('ai_response_cache');
                localStorage.removeItem('search_cache');
                log('🗑️ 所有数据已清空');
                updateStats();
            }
        }
        
        async function testAIServices() {
            log('🧪 测试AI服务连接...');
            await checkAIServices();
            log('✅ AI服务测试完成');
        }
        
        function viewKnowledgeBase() {
            const kb = JSON.parse(localStorage.getItem('crawled_knowledge_base') || '[]');
            if (kb.length === 0) {
                alert('知识库为空，请先添加一些内容。');
                return;
            }
            
            const summary = kb.slice(0, 5).map((item, index) => 
                `${index + 1}. ${item.title || '无标题'} (${item.url || '无URL'})`
            ).join('\n');
            
            alert(`知识库内容预览 (前5条):\n\n${summary}\n\n总计: ${kb.length} 条记录`);
        }
        
        function addContent() {
            const url = prompt('请输入要添加的网页URL:');
            if (url) {
                log(`📝 准备添加内容: ${url}`);
                alert('内容添加功能需要配置爬虫服务。请访问"爬取管理"页面进行配置。');
            }
        }
        
        function updateContent() {
            log('🔄 内容更新功能开发中...');
            alert('内容更新功能正在开发中，敬请期待！');
        }
        
        function generateReport() {
            const report = {
                timestamp: new Date().toISOString(),
                stats: {
                    knowledgeBase: JSON.parse(localStorage.getItem('crawled_knowledge_base') || '[]').length,
                    storageUsage: Object.keys(localStorage).reduce((total, key) => total + localStorage[key].length, 0),
                },
                logs: systemLogs.slice(-20) // 最近20条日志
            };
            
            const blob = new Blob([JSON.stringify(report, null, 2)], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `system-report-${new Date().toISOString().split('T')[0]}.json`;
            a.click();
            URL.revokeObjectURL(url);
            
            log('📊 系统报告已生成');
        }
        
        function downloadLogs() {
            const logText = systemLogs.join('\n');
            const blob = new Blob([logText], { type: 'text/plain' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `system-logs-${new Date().toISOString().split('T')[0]}.txt`;
            a.click();
            URL.revokeObjectURL(url);
            
            log('📄 日志文件已下载');
        }
        
        function clearLogs() {
            systemLogs = [];
            document.getElementById('systemLogs').textContent = '日志已清空';
            log('🗑️ 系统日志已清空');
        }
        
        function log(message) {
            const timestamp = new Date().toLocaleTimeString();
            const logEntry = `[${timestamp}] ${message}`;
            systemLogs.push(logEntry);
            
            // 限制日志数量
            if (systemLogs.length > 100) {
                systemLogs = systemLogs.slice(-50);
            }
            
            // 更新日志显示
            const logViewer = document.getElementById('systemLogs');
            logViewer.textContent = systemLogs.slice(-10).join('\n');
            logViewer.scrollTop = logViewer.scrollHeight;
        }
    </script>
</body>
</html>
