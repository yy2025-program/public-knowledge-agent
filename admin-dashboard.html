<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ç®¡ç†é¢æ¿ - AI Knowledge Agent</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Inter', 'Segoe UI', sans-serif;
            background: linear-gradient(135deg, #0f0f23 0%, #1a1a2e 50%, #16213e 100%);
            min-height: 100vh;
            color: #e2e8f0;
            padding: 20px;
        }
        
        .dashboard {
            max-width: 1200px;
            margin: 0 auto;
        }
        
        .header {
            text-align: center;
            margin-bottom: 30px;
        }
        
        .header h1 {
            font-size: 2.5rem;
            margin-bottom: 10px;
            background: linear-gradient(135deg, #10b981, #3b82f6);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }
        
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }
        
        .stat-card {
            background: rgba(255, 255, 255, 0.05);
            backdrop-filter: blur(20px);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 16px;
            padding: 24px;
            text-align: center;
        }
        
        .stat-card h3 {
            font-size: 0.9rem;
            color: rgba(226, 232, 240, 0.7);
            margin-bottom: 8px;
        }
        
        .stat-card .value {
            font-size: 2rem;
            font-weight: 700;
            margin-bottom: 8px;
        }
        
        .stat-card .change {
            font-size: 0.8rem;
            padding: 4px 8px;
            border-radius: 12px;
        }
        
        .positive { background: rgba(16, 185, 129, 0.2); color: #10b981; }
        .negative { background: rgba(239, 68, 68, 0.2); color: #ef4444; }
        .neutral { background: rgba(156, 163, 175, 0.2); color: #9ca3af; }
        
        .control-panel {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }
        
        .panel-section {
            background: rgba(255, 255, 255, 0.05);
            backdrop-filter: blur(20px);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 16px;
            padding: 24px;
        }
        
        .panel-section h3 {
            margin-bottom: 16px;
            color: #e2e8f0;
        }
        
        .btn {
            padding: 10px 16px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 500;
            margin: 4px;
            transition: all 0.3s ease;
        }
        
        .btn-primary { background: #3b82f6; color: white; }
        .btn-success { background: #10b981; color: white; }
        .btn-warning { background: #f59e0b; color: white; }
        .btn-danger { background: #ef4444; color: white; }
        
        .btn:hover { transform: translateY(-1px); opacity: 0.9; }
        
        .log-viewer {
            background: rgba(0, 0, 0, 0.3);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 8px;
            padding: 16px;
            height: 200px;
            overflow-y: auto;
            font-family: 'Courier New', monospace;
            font-size: 0.8rem;
            line-height: 1.4;
        }
        
        .progress-bar {
            background: rgba(255, 255, 255, 0.1);
            border-radius: 10px;
            height: 8px;
            overflow: hidden;
            margin: 8px 0;
        }
        
        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, #10b981, #3b82f6);
            transition: width 0.3s ease;
        }
        
        .status-indicator {
            display: inline-block;
            width: 8px;
            height: 8px;
            border-radius: 50%;
            margin-right: 8px;
        }
        
        .status-online { background: #10b981; }
        .status-offline { background: #ef4444; }
        .status-warning { background: #f59e0b; }
        
        .back-link {
            text-align: center;
            margin-top: 30px;
        }
        
        .back-link a {
            color: #60a5fa;
            text-decoration: none;
            padding: 10px 20px;
            border: 1px solid rgba(96, 165, 250, 0.3);
            border-radius: 20px;
            transition: all 0.3s ease;
        }
        
        .back-link a:hover {
            background: rgba(96, 165, 250, 0.1);
            border-color: rgba(96, 165, 250, 0.5);
        }
    </style>
</head>
<body>
    <div class="dashboard">
        <div class="header">
            <h1>ğŸ› ï¸ ç³»ç»Ÿç®¡ç†é¢æ¿</h1>
            <p>AI Knowledge Agent è¿è¡ŒçŠ¶æ€ç›‘æ§ä¸ç®¡ç†</p>
        </div>
        
        <!-- ç»Ÿè®¡å¡ç‰‡ -->
        <div class="stats-grid">
            <div class="stat-card">
                <h3>çŸ¥è¯†åº“æ¡ç›®</h3>
                <div class="value" id="knowledgeCount">-</div>
                <div class="change neutral" id="knowledgeChange">åŠ è½½ä¸­...</div>
            </div>
            
            <div class="stat-card">
                <h3>å­˜å‚¨ä½¿ç”¨ç‡</h3>
                <div class="value" id="storageUsage">-</div>
                <div class="change" id="storageChange">-</div>
            </div>
            
            <div class="stat-card">
                <h3>AIæœåŠ¡çŠ¶æ€</h3>
                <div class="value" id="aiStatus">-</div>
                <div class="change" id="aiChange">æ£€æµ‹ä¸­...</div>
            </div>
            
            <div class="stat-card">
                <h3>æœ€ååŒæ­¥</h3>
                <div class="value" id="lastSync">-</div>
                <div class="change" id="syncStatus">-</div>
            </div>
        </div>
        
        <!-- æ§åˆ¶é¢æ¿ -->
        <div class="control-panel">
            <!-- æ•°æ®ç®¡ç† -->
            <div class="panel-section">
                <h3>ğŸ“Š æ•°æ®ç®¡ç†</h3>
                <button class="btn btn-primary" onclick="refreshData()">åˆ·æ–°æ•°æ®</button>
                <button class="btn btn-success" onclick="exportData()">å¯¼å‡ºæ•°æ®</button>
                <button class="btn btn-warning" onclick="optimizeData()">ä¼˜åŒ–æ•°æ®</button>
                <button class="btn btn-danger" onclick="clearData()">æ¸…ç©ºæ•°æ®</button>
                
                <div style="margin-top: 16px;">
                    <div>å­˜å‚¨ç©ºé—´ä½¿ç”¨æƒ…å†µ:</div>
                    <div class="progress-bar">
                        <div class="progress-fill" id="storageProgress" style="width: 0%"></div>
                    </div>
                    <div style="font-size: 0.8rem; color: rgba(226, 232, 240, 0.7);" id="storageDetails">-</div>
                </div>
            </div>
            
            <!-- çˆ¬è™«ç®¡ç† -->
            <div class="panel-section">
                <h3>ğŸ•·ï¸ çˆ¬è™«ç®¡ç†</h3>
                <button class="btn btn-primary" onclick="startCrawling()">å¼€å§‹çˆ¬å–</button>
                <button class="btn btn-warning" onclick="pauseCrawling()">æš‚åœçˆ¬å–</button>
                <button class="btn btn-success" onclick="batchCrawl()">æ‰¹é‡çˆ¬å–</button>
                
                <div style="margin-top: 16px;">
                    <div>çˆ¬å–è¿›åº¦:</div>
                    <div class="progress-bar">
                        <div class="progress-fill" id="crawlProgress" style="width: 0%"></div>
                    </div>
                    <div style="font-size: 0.8rem; color: rgba(226, 232, 240, 0.7);" id="crawlStatus">å°±ç»ª</div>
                </div>
            </div>
            
            <!-- AIæœåŠ¡ç®¡ç† -->
            <div class="panel-section">
                <h3>ğŸ¤– AIæœåŠ¡ç®¡ç†</h3>
                <div style="margin-bottom: 12px;">
                    <span class="status-indicator" id="githubStatus"></span>
                    GitHub Models
                </div>
                <div style="margin-bottom: 12px;">
                    <span class="status-indicator" id="bedrockStatus"></span>
                    AWS Bedrock
                </div>
                
                <button class="btn btn-primary" onclick="testAIServices()">æµ‹è¯•æœåŠ¡</button>
                <button class="btn btn-success" onclick="window.open('ai-config.html', '_blank')">é…ç½®AI</button>
            </div>
            
            <!-- ç³»ç»Ÿç›‘æ§ -->
            <div class="panel-section">
                <h3>ğŸ“ˆ ç³»ç»Ÿç›‘æ§</h3>
                <button class="btn btn-primary" onclick="generateReport()">ç”ŸæˆæŠ¥å‘Š</button>
                <button class="btn btn-success" onclick="downloadLogs()">ä¸‹è½½æ—¥å¿—</button>
                <button class="btn btn-warning" onclick="clearLogs()">æ¸…ç©ºæ—¥å¿—</button>
                
                <div style="margin-top: 16px;">
                    <div>ç³»ç»Ÿæ—¥å¿—:</div>
                    <div class="log-viewer" id="systemLogs">ç³»ç»Ÿå¯åŠ¨ä¸­...</div>
                </div>
            </div>
        </div>
        
        <div class="back-link">
            <a href="index.html">â† è¿”å›ä¸»é¡µ</a>
        </div>
    </div>
    
    <script src="enhanced-crawler.js"></script>
    <script src="smart-answer-generator.js"></script>
    <script src="data-sync-manager.js"></script>
    <script src="github-models-integration.js"></script>
    <script>
        let systemLogs = [];
        let crawlInProgress = false;
        
        // é¡µé¢åŠ è½½æ—¶åˆå§‹åŒ–
        window.onload = function() {
            initializeDashboard();
            updateStats();
            setInterval(updateStats, 30000); // æ¯30ç§’æ›´æ–°ä¸€æ¬¡
        };
        
        function initializeDashboard() {
            log('ç®¡ç†é¢æ¿åˆå§‹åŒ–å®Œæˆ');
            checkAIServices();
        }
        
        function updateStats() {
            updateKnowledgeStats();
            updateStorageStats();
            updateSyncStats();
        }
        
        function updateKnowledgeStats() {
            const knowledgeBase = JSON.parse(localStorage.getItem('crawled_knowledge_base') || '[]');
            const count = knowledgeBase.length;
            
            document.getElementById('knowledgeCount').textContent = count;
            document.getElementById('knowledgeChange').textContent = `${count} æ¡è®°å½•`;
            document.getElementById('knowledgeChange').className = count > 0 ? 'change positive' : 'change neutral';
        }
        
        function updateStorageStats() {
            let totalSize = 0;
            for (let key in localStorage) {
                if (localStorage.hasOwnProperty(key)) {
                    totalSize += localStorage[key].length;
                }
            }
            
            const usageMB = (totalSize / 1024 / 1024).toFixed(2);
            const usagePercent = Math.min((totalSize / (5 * 1024 * 1024)) * 100, 100);
            
            document.getElementById('storageUsage').textContent = `${usageMB}MB`;
            document.getElementById('storageChange').textContent = `${usagePercent.toFixed(1)}% å·²ä½¿ç”¨`;
            document.getElementById('storageChange').className = usagePercent > 80 ? 'change negative' : 
                                                                usagePercent > 60 ? 'change warning' : 'change positive';
            
            document.getElementById('storageProgress').style.width = `${usagePercent}%`;
            document.getElementById('storageDetails').textContent = `${usageMB}MB / 5.00MB (${usagePercent.toFixed(1)}%)`;
        }
        
        function updateSyncStats() {
            const lastSyncTime = localStorage.getItem('last_sync_time');
            if (lastSyncTime) {
                const syncDate = new Date(parseInt(lastSyncTime));
                const now = new Date();
                const diffMinutes = Math.floor((now - syncDate) / 60000);
                
                if (diffMinutes < 60) {
                    document.getElementById('lastSync').textContent = `${diffMinutes}åˆ†é’Ÿå‰`;
                } else if (diffMinutes < 1440) {
                    document.getElementById('lastSync').textContent = `${Math.floor(diffMinutes/60)}å°æ—¶å‰`;
                } else {
                    document.getElementById('lastSync').textContent = `${Math.floor(diffMinutes/1440)}å¤©å‰`;
                }
                
                document.getElementById('syncStatus').textContent = diffMinutes < 60 ? 'æœ€æ–°' : 'éœ€è¦åŒæ­¥';
                document.getElementById('syncStatus').className = diffMinutes < 60 ? 'change positive' : 'change warning';
            } else {
                document.getElementById('lastSync').textContent = 'ä»æœª';
                document.getElementById('syncStatus').textContent = 'éœ€è¦åŒæ­¥';
                document.getElementById('syncStatus').className = 'change negative';
            }
        }
        
        async function checkAIServices() {
            // æ£€æŸ¥GitHub Models
            const githubToken = localStorage.getItem('github_models_token');
            const githubStatus = document.getElementById('githubStatus');
            
            if (githubToken) {
                try {
                    const githubAI = new GitHubModelsAI();
                    const isWorking = await githubAI.testConnection();
                    githubStatus.className = isWorking ? 'status-indicator status-online' : 'status-indicator status-offline';
                    document.getElementById('aiStatus').textContent = isWorking ? 'åœ¨çº¿' : 'ç¦»çº¿';
                    document.getElementById('aiChange').textContent = isWorking ? 'GitHub Models å¯ç”¨' : 'GitHub Models ä¸å¯ç”¨';
                    document.getElementById('aiChange').className = isWorking ? 'change positive' : 'change negative';
                } catch (error) {
                    githubStatus.className = 'status-indicator status-offline';
                    log(`GitHub Models è¿æ¥å¤±è´¥: ${error.message}`);
                }
            } else {
                githubStatus.className = 'status-indicator status-warning';
                document.getElementById('aiStatus').textContent = 'æœªé…ç½®';
                document.getElementById('aiChange').textContent = 'éœ€è¦é…ç½®AIæœåŠ¡';
                document.getElementById('aiChange').className = 'change neutral';
            }
            
            // æ£€æŸ¥Bedrock (ç®€åŒ–æ£€æŸ¥)
            const bedrockStatus = document.getElementById('bedrockStatus');
            const bedrockKey = localStorage.getItem('bedrock_api_key');
            bedrockStatus.className = bedrockKey ? 'status-indicator status-warning' : 'status-indicator status-offline';
        }
        
        function refreshData() {
            log('åˆ·æ–°æ•°æ®...');
            updateStats();
            checkAIServices();
            log('æ•°æ®åˆ·æ–°å®Œæˆ');
        }
        
        function exportData() {
            const data = {
                knowledgeBase: JSON.parse(localStorage.getItem('crawled_knowledge_base') || '[]'),
                settings: {
                    github_token: localStorage.getItem('github_models_token') ? '***' : null,
                    github_model: localStorage.getItem('github_models_current'),
                    last_sync: localStorage.getItem('last_sync_time')
                },
                exportTime: new Date().toISOString()
            };
            
            const blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `ai-knowledge-backup-${new Date().toISOString().split('T')[0]}.json`;
            a.click();
            URL.revokeObjectURL(url);
            
            log('æ•°æ®å¯¼å‡ºå®Œæˆ');
        }
        
        function optimizeData() {
            log('å¼€å§‹æ•°æ®ä¼˜åŒ–...');
            
            if (window.DataSyncManager) {
                const syncManager = new DataSyncManager();
                syncManager.optimizeDataStructure();
                syncManager.cleanExpiredCache();
                log('æ•°æ®ä¼˜åŒ–å®Œæˆ');
            } else {
                // ç®€å•ä¼˜åŒ–
                const kb = JSON.parse(localStorage.getItem('crawled_knowledge_base') || '[]');
                const optimized = kb.slice(0, 500); // åªä¿ç•™500æ¡æœ€æ–°çš„
                localStorage.setItem('crawled_knowledge_base', JSON.stringify(optimized));
                log(`æ•°æ®ä¼˜åŒ–å®Œæˆ: ${kb.length} -> ${optimized.length} æ¡è®°å½•`);
            }
            
            updateStats();
        }
        
        function clearData() {
            if (confirm('ç¡®å®šè¦æ¸…ç©ºæ‰€æœ‰æ•°æ®å—ï¼Ÿæ­¤æ“ä½œä¸å¯æ¢å¤ï¼')) {
                localStorage.removeItem('crawled_knowledge_base');
                localStorage.removeItem('ai_response_cache');
                localStorage.removeItem('search_cache');
                log('æ‰€æœ‰æ•°æ®å·²æ¸…ç©º');
                updateStats();
            }
        }
        
        async function startCrawling() {
            if (crawlInProgress) {
                log('çˆ¬å–ä»»åŠ¡å·²åœ¨è¿›è¡Œä¸­');
                return;
            }
            
            crawlInProgress = true;
            log('å¼€å§‹çˆ¬å–ä»»åŠ¡...');
            
            // ç¤ºä¾‹URLåˆ—è¡¨
            const urls = [
                'https://sellercentral.amazon.com/help/hub/reference/G200141510',
                'https://sellercentral.amazon.com/help/hub/reference/G53921',
                'https://sellercentral.amazon.com/help/hub/reference/G201074400'
            ];
            
            if (window.EnhancedCrawler) {
                const crawler = new EnhancedCrawler();
                
                try {
                    for (let i = 0; i < urls.length; i++) {
                        const progress = ((i + 1) / urls.length) * 100;
                        document.getElementById('crawlProgress').style.width = `${progress}%`;
                        document.getElementById('crawlStatus').textContent = `çˆ¬å–ä¸­... ${i + 1}/${urls.length}`;
                        
                        await crawler.crawlSingleUrl(urls[i]);
                        log(`å·²çˆ¬å–: ${urls[i]}`);
                    }
                    
                    log('çˆ¬å–ä»»åŠ¡å®Œæˆ');
                    document.getElementById('crawlStatus').textContent = 'çˆ¬å–å®Œæˆ';
                } catch (error) {
                    log(`çˆ¬å–å¤±è´¥: ${error.message}`);
                    document.getElementById('crawlStatus').textContent = 'çˆ¬å–å¤±è´¥';
                }
            } else {
                log('çˆ¬è™«æ¨¡å—æœªåŠ è½½');
            }
            
            crawlInProgress = false;
            updateStats();
        }
        
        function pauseCrawling() {
            crawlInProgress = false;
            document.getElementById('crawlStatus').textContent = 'å·²æš‚åœ';
            log('çˆ¬å–ä»»åŠ¡å·²æš‚åœ');
        }
        
        function batchCrawl() {
            const urls = prompt('è¯·è¾“å…¥è¦çˆ¬å–çš„URLåˆ—è¡¨ï¼ˆæ¯è¡Œä¸€ä¸ªï¼‰:');
            if (urls) {
                const urlList = urls.split('\n').filter(url => url.trim());
                log(`å‡†å¤‡æ‰¹é‡çˆ¬å– ${urlList.length} ä¸ªURL`);
                // è¿™é‡Œå¯ä»¥è°ƒç”¨æ‰¹é‡çˆ¬å–åŠŸèƒ½
            }
        }
        
        async function testAIServices() {
            log('æµ‹è¯•AIæœåŠ¡è¿æ¥...');
            await checkAIServices();
            log('AIæœåŠ¡æµ‹è¯•å®Œæˆ');
        }
        
        function generateReport() {
            const report = {
                timestamp: new Date().toISOString(),
                stats: {
                    knowledgeBase: JSON.parse(localStorage.getItem('crawled_knowledge_base') || '[]').length,
                    storageUsage: Object.keys(localStorage).reduce((total, key) => total + localStorage[key].length, 0),
                    lastSync: localStorage.getItem('last_sync_time')
                },
                logs: systemLogs.slice(-50) // æœ€è¿‘50æ¡æ—¥å¿—
            };
            
            const blob = new Blob([JSON.stringify(report, null, 2)], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `system-report-${new Date().toISOString().split('T')[0]}.json`;
            a.click();
            URL.revokeObjectURL(url);
            
            log('ç³»ç»ŸæŠ¥å‘Šå·²ç”Ÿæˆ');
        }
        
        function downloadLogs() {
            const logText = systemLogs.join('\n');
            const blob = new Blob([logText], { type: 'text/plain' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `system-logs-${new Date().toISOString().split('T')[0]}.txt`;
            a.click();
            URL.revokeObjectURL(url);
            
            log('æ—¥å¿—æ–‡ä»¶å·²ä¸‹è½½');
        }
        
        function clearLogs() {
            systemLogs = [];
            document.getElementById('systemLogs').textContent = 'æ—¥å¿—å·²æ¸…ç©º';
            log('ç³»ç»Ÿæ—¥å¿—å·²æ¸…ç©º');
        }
        
        function log(message) {
            const timestamp = new Date().toLocaleTimeString();
            const logEntry = `[${timestamp}] ${message}`;
            systemLogs.push(logEntry);
            
            // é™åˆ¶æ—¥å¿—æ•°é‡
            if (systemLogs.length > 100) {
                systemLogs = systemLogs.slice(-50);
            }
            
            // æ›´æ–°æ—¥å¿—æ˜¾ç¤º
            const logViewer = document.getElementById('systemLogs');
            logViewer.textContent = systemLogs.slice(-10).join('\n');
            logViewer.scrollTop = logViewer.scrollHeight;
        }
    </script>
</body>
</html>
